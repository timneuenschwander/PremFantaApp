{% extends 'base.html' %}
{% block title %}Home - Fantasy PL{% endblock %}
{% block content %}
<h1>Fantasy Premier League - Home</h1>

<div class="table-container">

    <div class="table-box" style="flex: 1; min-width: 500px;">
        <h2>Starting 11</h2>
        <div style="margin-bottom: 20px; text-align: center;">
            <div class="formation-select">
                <label for="formation">Choose Formation:</label>
                <select id="formation" onchange="changeFormation(this.value)">
                    <option value="1-4-3-3">1-4-3-3</option>
                    <option value="1-3-4-3">1-3-4-3</option>
                    <option value="1-4-4-2">1-4-4-2</option>
                    <option value="1-5-3-2">1-5-3-2</option>
                    <option value="1-3-5-2">1-3-5-2</option>
                </select>
            </div>
        </div>

        <div class="pitch-wrapper" style="background-image: url('{{ url_for('static', filename='lineup.png') }}'); background-size: cover; background-position: center;">
            <div class="pitch">
                {% for player in starters %}
                <div class="slot player-slot"
                    style="top: 0; left: 0;"
                    data-role="start"
                    data-slot-id="{{ loop.index0 }}">
                    
                    <div class="slot-label" id="slot-label-{{ loop.index0 }}"></div>
        
                    {% if player %}
                    <div class="player"
                        draggable="true"
                        data-id="{{ player.id }}"
                        data-role="start"
                        data-position="{{ player.position }}">
                        {{ player.name }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="table-box">
        <h2>Bench</h2>
        {% for player in bench %}
        <div class="slot" data-role="bench" data-slot-id="{{ loop.index0 }}">
            <div style="display: flex; align-items: center; width: 100%;">
                <div class="row-number">{{ loop.index }}</div>
        
                <div class="player"
                    draggable="true"
                    data-id="{{ player.id }}"
                    data-role="bench"
                    data-position="{{ player.position }}"
                    style="display: flex; width: 100%;">
                    <div class="player-name-box">{{ player.name }}</div>
                    <div class="player-position-box">{{ player.position }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="table-box">
        <h2>Reserves</h2>
        {% for player in reserves %}
        <div class="slot" data-role="bench" data-slot-id="{{ loop.index0 }}">
            <div style="display: flex; align-items: center; width: 100%;">
                <div class="row-number">{{ loop.index }}</div>
        
                <div class="player"
                    draggable="true"
                    data-id="{{ player.id }}"
                    data-role="bench"
                    data-position="{{ player.position }}"
                    style="display: flex; width: 100%;">
                    <div class="player-name-box">{{ player.name }}</div>
                    <div class="player-position-box">{{ player.position }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div class="table-container">
    <div style="background-color: var(--green-4); padding: 20px; border-radius: 10px; margin: auto; display: flex; align-items: center; width: 100%;">
        <form method="POST" action="/save_lineup">
            <label for="title" style="font-weight: bold; color: var(--primary-green);">Title of the lineup:</label>
            <input type="text" id="title" name="title" required placeholder="z.B. GW1"
                   style="margin: 0 10px; padding: 6px; border-radius: 6px; border: none;">
            <button type="submit"
                    style="padding: 6px 12px; background-color: var(--primary-green); color: var(--green-bg); font-weight: bold; border: none; border-radius: 6px;">
                Save
            </button>
        </form>
    </div>
</div>
<script>
    let draggedPlayer = null;

    document.querySelectorAll('.player').forEach(player => {
        player.addEventListener('dragstart', () => {
            draggedPlayer = player;
            player.classList.add('dragging');
        });

        player.addEventListener('dragend', () => {
            player.classList.remove('dragging');
            draggedPlayer = null;
        });
    });

    document.querySelectorAll('.slot').forEach(slot => {
        slot.addEventListener('dragover', e => {
            e.preventDefault();
        });

        slot.addEventListener('drop', async e => {
            e.preventDefault();
            const targetPlayer = slot.querySelector('.player');
            const targetId = targetPlayer ? targetPlayer.dataset.id : null;

            if (!draggedPlayer) return;

            const draggedId = draggedPlayer.dataset.id;
            const sourceRole = draggedPlayer.dataset.role;
            const targetRole = slot.dataset.role;

            function renderPlayerDiv(playerElement, newRole) {
                const name = playerElement.querySelector('.player-name-box')?.innerText || playerElement.innerText;
                const position = playerElement.dataset.position;
                playerElement.dataset.role = newRole;

                if (newRole === "start") {
                    playerElement.innerHTML = name;
                    playerElement.style.display = '';
                } else {
                    playerElement.innerHTML = `
                        <div class="player-name-box">${name}</div>
                        <div class="player-position-box">${position}</div>
                    `;
                    playerElement.style.display = 'flex';
                    playerElement.style.width = '100%';
                }
            }

            const sourceSlot = draggedPlayer.parentNode;

            if (targetPlayer) {
                // --- Save the role of both players
                const draggedId = draggedPlayer.dataset.id;
                const draggedPosition = draggedPlayer.dataset.position;
                const targetId = targetPlayer.dataset.id;
                const targetPosition = targetPlayer.dataset.position;

                // --- Source and target slots
                const sourceSlot = draggedPlayer.parentNode.closest('.slot');
                const sourceSlotId = sourceSlot.dataset.slotId;
                const targetSlot = slot;

                // --- Remove player divs from both slots
                targetPlayer.remove();
                draggedPlayer.remove();

                // --- Re-render dragged player in target slot
                renderPlayerDiv(draggedPlayer, targetRole);
                if (targetRole !== 'start') {
                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    wrapper.style.width = '100%';

                    const rowNumber = document.createElement('div');
                    rowNumber.classList.add('row-number');
                    rowNumber.innerText = parseInt(targetSlot.dataset.slotId) + 1;

                    wrapper.appendChild(rowNumber);
                    wrapper.appendChild(draggedPlayer);

                    targetSlot.innerHTML = ''; // Don't remove label for 'start'
                    targetSlot.appendChild(wrapper);
                } else {
                    const labelDiv = targetSlot.querySelector('.slot-label');
                    targetSlot.innerHTML = ''; // Clear slot but keep label
                    targetSlot.appendChild(labelDiv); // Restore label
                    targetSlot.appendChild(draggedPlayer);
                }

                // --- Re-render targetPlayer into source slot
                renderPlayerDiv(targetPlayer, sourceRole);
                if (sourceRole !== 'start') {
                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    wrapper.style.width = '100%';

                    const rowNumber = document.createElement('div');
                    rowNumber.classList.add('row-number');
                    rowNumber.innerText = parseInt(sourceSlot.dataset.slotId) + 1;

                    wrapper.appendChild(rowNumber);
                    wrapper.appendChild(targetPlayer);

                    sourceSlot.innerHTML = '';
                    sourceSlot.appendChild(wrapper);
                } else {
                    const labelDiv = sourceSlot.querySelector('.slot-label');
                    sourceSlot.innerHTML = '';
                    sourceSlot.appendChild(labelDiv);
                    sourceSlot.appendChild(targetPlayer);
                }

                // --- Update role attributes
                draggedPlayer.dataset.role = targetRole;
                targetPlayer.dataset.role = sourceRole;

                // --- Backend call
                const response = await fetch('/swap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dragged_id: draggedId,
                        target_id: targetId,
                        source_role: sourceRole,
                        target_role: targetRole
                    })
                });

                if (!response.ok) {
                    alert("Error swapping players");
                }
            }
        });
    });
    
    function changeFormation(value) {
    // This will be used in Step 2 to reposition slots based on formation
    console.log("Selected Formation:", value);
    // TODO: Update slot positions based on selected formation
    }

    const FORMATIONS = {
        "1-4-3-3": [
            { top: "85%", left: "39%" },
            { top: "63%", left: "9%" },
            { top: "72%", left: "25%" },
            { top: "72%", left: "53%" },
            { top: "63%", left: "69%" },
            { top: "44%", left: "12%" },
            { top: "46%", left: "39%" },
            { top: "44%", left: "66%" },
            { top: "28%", left: "12%" },
            { top: "23%", left: "39%" },
            { top: "28%", left: "66%" } 
        ],
        "1-3-4-3": [
            { top: "85%", left: "39%" },
            { top: "68%", left: "14%" },
            { top: "70%", left: "39%" },
            { top: "68%", left: "64%" },
            { top: "44%", left: "9%" },
            { top: "54%", left: "23%" },
            { top: "54%", left: "55%" },
            { top: "44%", left: "69%" },
            { top: "28%", left: "12%" },
            { top: "23%", left: "39%" },
            { top: "28%", left: "66%" } 
        ],
        "1-4-4-2": [
            { top: "85%", left: "39%" },
            { top: "63%", left: "9%" },
            { top: "72%", left: "25%" },
            { top: "72%", left: "53%" },
            { top: "63%", left: "69%" },
            { top: "39%", left: "9%" },
            { top: "49%", left: "23%" },
            { top: "49%", left: "55%" },
            { top: "39%", left: "69%" },
            { top: "25%", left: "21%" },
            { top: "25%", left: "57%" }
        ],
        "1-5-3-2": [
            { top: "85%", left: "39%" },
            { top: "60%", left: "4%" },
            { top: "71%", left: "14%" },
            { top: "73%", left: "39%" },
            { top: "71%", left: "64%" },
            { top: "60%", left: "74%" },
            { top: "44%", left: "12%" },
            { top: "46%", left: "39%" },
            { top: "44%", left: "66%" },
            { top: "25%", left: "21%" },
            { top: "25%", left: "57%" }
        ],
        "1-3-5-2": [
            { top: "85%", left: "39%" },
            { top: "68%", left: "14%" },
            { top: "70%", left: "39%" },
            { top: "68%", left: "64%" },
            { top: "43%", left: "9%" },
            { top: "54%", left: "23%" },
            { top: "39%", left: "39%" },
            { top: "54%", left: "55%" },
            { top: "43%", left: "69%" },
            { top: "25%", left: "21%" },
            { top: "25%", left: "57%" }
        ]
    };

        const FORMATION_POSITIONS = {
            "1-4-3-3": ["GK", "LB", "CB", "CB", "RB", "CM", "CM", "CM", "LW", "ST", "RW"],
            "1-3-4-3": ["GK", "CB", "CB", "CB", "LM", "CM", "CM", "RM", "LW", "ST", "RW"],
            "1-4-4-2": ["GK", "LB", "CB", "CB", "RB", "LM", "CM", "CM", "RM", "ST", "ST"],
            "1-5-3-2": ["GK", "LWB", "CB", "CB", "CB", "RWB", "CM", "CM", "CM", "ST", "ST"],
            "1-3-5-2": ["GK", "CB", "CB", "CB", "LM", "CDM", "CAM", "CDM", "RM", "ST", "ST"]
        };

        function applyFormation(formation) {
            const slots = document.querySelectorAll('.player-slot');
            const coords = FORMATIONS[formation];
            const labels = FORMATION_POSITIONS[formation];

            coords.forEach((pos, index) => {
                if (slots[index]) {
                    slots[index].style.top = pos.top;
                    slots[index].style.left = pos.left;

                    const labelDiv = slots[index].querySelector('.slot-label');
                    if (labelDiv) {
                        labelDiv.innerText = labels[index];
                    }
                }
            });
        }   

    document.addEventListener('DOMContentLoaded', () => {
    const formationSelect = document.getElementById("formation");
    applyFormation(formationSelect.value);

    formationSelect.addEventListener("change", () => {
        applyFormation(formationSelect.value);
    });
});
</script>

{% endblock %}