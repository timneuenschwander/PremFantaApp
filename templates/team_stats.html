{% extends 'base.html' %}
{% block title %}Team Stats - Fantasy PL{% endblock %}
{% block content %}
<h1>Edit Full Squad</h1>

<table id="statsTable" class="sortable">
    <thead>
        <tr>
            <th>Name <span class="sort-icon" data-index="0">↕</span></th>
            <th>Position <span class="sort-icon" data-index="1">↕</span></th>
            <th>Team <span class="sort-icon" data-index="2">↕</span></th>
            <th>Market Value <span class="sort-icon" data-index="3">↕</span></th>
            <th>Bid Value <span class="sort-icon" data-index="4">↕</span></th>
            <th>Role <span class="sort-icon" data-index="5">↕</span></th>
        </tr>
    </thead>
    <tbody>
        <form method="POST">
        {% for player in players %}
        <tr>
            <input type="hidden" name="player_{{ player.id }}" value="1">
            <td><input type="text" name="name_{{ player.id }}" value="{{ player.name }}"></td>
            <td><input type="text" name="position_{{ player.id }}" value="{{ player.position }}"></td>
            <td><input type="text" name="team_{{ player.id }}" value="{{ player.team }}"></td>
            <td><input type="number" step="0.01" name="market_{{ player.id }}" value="{{ player.market_value }}"></td>
            <td><input type="number" step="0.01" name="bid_{{ player.id }}" value="{{ player.bid_value }}"></td>
            <td><input type="text" name="role_{{ player.id }}" value="{{ player.role }}"></td>
        </tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align: right;"><strong>Totals:</strong></td>
                <td id="totalMarket">0</td>
                <td id="totalBid">0</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <br>
    <button type="submit">Save Changes</button>
    </form>

<script>
    function updateTotals() {
        let totalMarket = 0;
        let totalBid = 0;
        document.querySelectorAll('input[name^="market_"]').forEach(input => {
            totalMarket += parseFloat(input.value || 0);
        });
        document.querySelectorAll('input[name^="bid_"]').forEach(input => {
            totalBid += parseFloat(input.value || 0);
        });
        document.getElementById("totalMarket").innerText = totalMarket.toFixed(2);
        document.getElementById("totalBid").innerText = totalBid.toFixed(2);
    }

    document.addEventListener("input", updateTotals);
    window.addEventListener("load", updateTotals);
    
    document.querySelectorAll(".sort-icon").forEach(icon => {
        icon.addEventListener("click", () => {
            const table = document.getElementById("statsTable");
            const index = parseInt(icon.getAttribute("data-index"));
            const isAsc = icon.classList.contains("asc");

            const rows = Array.from(table.querySelector("tbody").rows);
            rows.sort((a, b) => {
                const getVal = (row) =>
                    row.cells[index].querySelector("input")?.value || row.cells[index].innerText;
                const aVal = getVal(a);
                const bVal = getVal(b);

                return isAsc
                    ? bVal.localeCompare(aVal, undefined, { numeric: true })
                    : aVal.localeCompare(bVal, undefined, { numeric: true });
            });

            rows.forEach(row => table.querySelector("tbody").appendChild(row));

            // Reset all icons
            document.querySelectorAll(".sort-icon").forEach(i => {
                i.classList.remove("asc", "desc");
                i.innerText = "↕";
            });

            // Update the clicked icon
            icon.classList.add(isAsc ? "desc" : "asc");
            icon.innerText = isAsc ? "↓" : "↑";
        });
    });
</script>
{% endblock %}
